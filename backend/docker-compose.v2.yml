version: '3.8'

services:
  api_v2:
    build: 
      context: .
      dockerfile: engines/indicator-engine/Dockerfile
    container_name: crypto_api_v2
    command: uvicorn api_v2.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    env_file: .env
    environment:
      POSTGRES_HOST: timescaledb
      REDIS_HOST: redis
      PYTHONPATH: .
    depends_on:
      timescaledb: { condition: service_healthy }
      redis: { condition: service_healthy }
    restart: always

  data-engine:
    build:
      context: .
      dockerfile: engines/indicator-engine/Dockerfile
    container_name: crypto_data_engine
    command: python3 engines/data-engine/main.py
    env_file: .env
    environment:
      POSTGRES_HOST: timescaledb
      REDIS_HOST: redis
    depends_on:
      redis: { condition: service_healthy }
    restart: always

  ie-scheduler:
    build:
      context: .
      dockerfile: engines/indicator-engine/Dockerfile
    container_name: crypto_ie_scheduler
    command: python3 engines/indicator-engine/scheduler.py
    env_file: .env
    environment:
      REDIS_HOST: redis
      PYTHONPATH: .
    depends_on:
      redis: { condition: service_healthy }
    restart: always

  ie-worker:
    build:
      context: .
      dockerfile: engines/indicator-engine/Dockerfile
    command: python3 engines/indicator-engine/worker.py
    env_file: .env
    cpus: 1.0
    mem_limit: 512M
    environment:
      POSTGRES_HOST: timescaledb
      REDIS_HOST: redis
      PYTHONPATH: .
      PYTHONWARNINGS: ignore
      OMP_NUM_THREADS: 1
      MKL_NUM_THREADS: 1
      OPENBLAS_NUM_THREADS: 1
    depends_on:
      redis: { condition: service_healthy }
    restart: always

  backfill-engine:
    build:
      context: .
      dockerfile: engines/indicator-engine/Dockerfile
    container_name: crypto_backfill_engine
    command: python3 engines/backfill-engine/main.py
    env_file: .env
    environment:
      POSTGRES_HOST: timescaledb
      PYTHONPATH: .
    depends_on:
      timescaledb: { condition: service_healthy }
    restart: always

  strategy-engine:
    build:
      context: .
      dockerfile: engines/indicator-engine/Dockerfile
    container_name: crypto_strategy_engine
    command: python3 engines/strategy-engine/main.py
    env_file: .env
    environment:
      POSTGRES_HOST: timescaledb
      REDIS_HOST: redis
      PYTHONPATH: .
    depends_on:
      timescaledb: { condition: service_healthy }
      redis: { condition: service_healthy }
    restart: always

  notification-engine:
    build:
      context: .
      dockerfile: engines/indicator-engine/Dockerfile
    container_name: crypto_notification_engine
    command: python3 engines/notification-engine/main.py
    env_file: .env
    environment:
      POSTGRES_HOST: timescaledb
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      PYTHONPATH: .
    depends_on:
      timescaledb: { condition: service_healthy }
      restart: always

  control-panel:
    image: amir20/dozzle:latest
    container_name: crypto_control_panel
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8888:8080"
    restart: always

  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: crypto_db
    env_file: .env
    volumes:
      - ts_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always

  redis:
    image: redis:7-alpine
    container_name: crypto_redis
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: always

volumes:
  ts_data:
    external: true
    name: backend_ts_data